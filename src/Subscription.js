import React, { useContext, useEffect, useState } from 'react'
import SPageContainer from './components/SPageContainer'
import functions from '@react-native-firebase/functions'
import SText from './components/SText'
import IAP from 'react-native-iap'
import { Linking, Platform, TouchableOpacity, View } from 'react-native'
import useStyle from './util/useStyle'
import SButton from './components/SButton'
import dataContext from './dataContext'

const productIds = Platform.select({
  ios: [
    'com.cashflux.1monthstandardsubscription',
    'com.cashflux.1yearstandardsubscription',
  ]
})

const c = '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'

export default function Subscription() {
  const style = useStyle()
  const {subscription: storedSubscription} = useContext(dataContext)

  useEffect(init, [])
  const [subscriptions, setSubscriptions] = useState([])

  const [processing, setProcessing] = useState(false)
  const [error, setError] = useState('')

  function init() {
    IAP.flushFailedPurchasesCachedAsPendingAndroid()
    IAP.getSubscriptions(productIds)
      .then(subscriptions => setSubscriptions(subscriptions))
    
    const purchaseUpdateListener = IAP.purchaseUpdatedListener(async purchase => {
      console.log('listener')
      const receipt = purchase.transactionReceipt
      if(receipt) {
        console.log(receipt)
        await IAP.finishTransaction(purchase, false)
        const response = await functions().httpsCallable('validateIOSIAP')({ receipt })
        if(!response.data.success)
          setError(response.data.error)
      } else {
        setError('Failed to process subscription')
      }
      setProcessing(false)
    })

    const purchaseErrorSubscription = IAP.purchaseErrorListener(() => {
      setError('Failed to process subcription')
      setProcessing(false)
    })

    return () => {
      purchaseUpdateListener.remove()
      purchaseErrorSubscription.remove()
    }
  }

  return (
    <SPageContainer>
      <View style={{marginBottom: 20}}>
        <SText fontSize={35}>Subscription</SText>
      </View>
      {!!error && (
        <SText color={style.errorColor}>{error}</SText>
      )}
      <View
        style={{
          flexDirection: 'row',
          justifyContent: 'space-between'
        }}
      >
        {subscriptions.map(subscription => (
          <View>
            <TouchableOpacity
              style={{
                padding: 10,
                borderWidth: (storedSubscription == subscription.productId) ? 3 : 1,
                borderColor: (storedSubscription == subscription.productId) ? style.primaryColor : style.light,
                borderRadius: 10,
                alignItems: 'center',
              }}
              key={subscription.productId}
              onPress={() => {IAP.requestSubscription(subscription.productId); setProcessing(true); setError('')}}
              disabled={processing || storedSubscription}
            >
              <SText fontSize={10} color={style.lightText}>{subscription.description}</SText>
              <SText fontSize={12}>{subscription.title}</SText>
              <SText fontSize={25}>{subscription.localizedPrice}</SText>
            </TouchableOpacity>
            {storedSubscription == subscription.productId && (
              <SText fontSize={12}>Currently active</SText>
            )}
          </View>
        ))}
      </View>
      {storedSubscription && (
        <SButton
          text='Manage Subscription'
          action={() => {
            if(Platform.OS == 'ios')
              Linking.openURL('https://apps.apple.com/account/subscriptions')
            //TODO: link to android
          }}
        />
      )}
    </SPageContainer>
  )
}